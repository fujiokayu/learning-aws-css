## インシデントへの対応

- AWS Trusted Advisor
  - コスト、パフォーマンス、セキュリティ、フォールトトレランス、サービス制限の5つの観点からチェックを行なってくれる
  - レポートは日次。リアルタイム検知を行いたい場合は CloudWatch と組み合わせる
  - Trusted Advisor のチェックに基づいて CloudWatch Events を設定することはできません。
  - アクセスキーの漏洩は Trusted Advisor で
- AWS CloudFormation
  - CloudFormation テンプレートを使った環境である場合、すぐにその環境のコピーが作れるのでインシデント対応時に再現環境がすぐに作れる
  - ドリフト検出機能で稼働中の環境とテンプレートの差分を検出できる
- AWS ServiceCatalog
  - AWS Service Catalogは組織としてのガバナンスが適用された製品を、AWS利用者であるユーザー部門が早く簡単に立ち上げる事ができるサービスです。
  - Service Catalogは、CloudFormationテンプレートを[製品]としてインポートする事が出来ます。CloudFormationテンプレートには、多くのAWSサービスの構成情報を記載できます。これにより、スタンプを押すように統一的な環境を作成する事が出来ます。
  - 管理部門は製品とその設定（制約、アクセス許可）をポートフォリオとして登録します。マスタAMIの更新やNW設定等の変更があった場合は、新しいバージョンとして製品を登録します。
  - CloudFormationを単体で使う場合はAWSリソースを作成する権限が必要ですが、Service Catalogでは、起動制約を使う事で権限がなくても環境を作成する事が出来ます。
- VPC フローログ
  - 送信元と送信先の IP アドレス、ポート、プロトコル、開始時刻と終了時刻、パケット数とバイト数、アクションをキャプチャする個々のレコードで構成されるログ
  - VPC フローログと AWS Lambda を使って送信トラフィックを制限することはできません。プロキシは、フィルタリングと送信トラフィックを制限するために必要です
  - VPC フローログはポートスキャンのキャプチャに役立ち、AWS Lambda を使用して通知をトリガーすることができます。Amazon GuardDuty は基本的にこれらのサービスを統合します
- AWS Config
  - リソースの全設定変更について詳細情報を継続的にキャプチャする
  - コンプライアンス分析とセキュリティ分析を有効化
  - セキュリティを侵害するような設定変更を特定し、影響を軽減できる
  - Config ルールという機能で各設定がルールに準拠しているかチェックできる
    - EBS が暗号化されているか、S3 がパブリックになっていないか、SSH がパブリックに開いてないか、など
    - マネージドルールとカスタムルールがある
  - Config ルールで非準拠となったリソースに対して、検知したタイミングで自動修復を行うことができる
    - この機能が出るまでは、CloudEvents で Lambda を呼び出して修正する、というパターンが使われていた
  - restricted-ssh の AWS Config マネージドルールは、セキュリティグループを通じて SSH トラフィックが有効になっているかどうかを確認して通知するために作成することができる
  - IAM ポリシーを使用して、タグ付けされた AMI からのみ EC2 インスタンスを起動するようにユーザーまたはサービスを制限できます。また、AWS Config を使用して、未承認の AMI で起動されたインスタンスをチェックするルールを定義できます
  - オンプレミスでも使える。収集する対象のリソースは利用者が設定する
- Amazon API Gateway
- AWS CloudTrail
  - CloudWatch は DevOps や SRE、マネージャー層のためのモニタリングを提供する
  - KMS 鍵の使用履歴は全て CloudTrail に保存される
  - AWS 操作が自動的に記録される
  - 管理イベント、データイベント、インサイトイベント（検知された異常なアクティビティ）があり、デフォルトで有効なのは管理イベント
  - ダイジェストを使った整合性検証ができる
  - デフォルトでは、CloudTrailがユーザーのバケットに配信するログファイルは、AmazonS3が管理する暗号化キー（SSES3）を用いたAmazonサーバーサイド暗号化によって暗号化されます。
    - 直接管理可能なセキュリティレイヤーを提供するために、代わりにCloudTrailのログファイルにAWSKMS管理下の鍵によるサーバーサイド暗号化（SSEKMS）を使用することができます。
  - CloudTrail の証跡は [Write-only] イベントフィルターで構成して、書き込み変更のみをプッシュすることができます
  - CloudTrail のログ配信は15分以内という制約があるため、迅速でリアルタイムな処理には向いていない
  - CloudTrail は DynamoDB と統合されており、IP アドレス情報をもとに API 呼び出しを追跡できる
    - 一方で、CloudWatch は DevOps や SRE、マネージャー層のためのモニタリングを提供する
- Amazon CloudWatch
  - [How Amazon CloudWatch works](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/cloudwatch_architecture.html)
  - AWS 組み込みメトリクスとカスタムメトリクスをモニタリングする
  - サービスとアプリケーションのログファイルを収集して処理する
  - イベントを検出し、通知または自動応答により応答する
  - 最大15ヶ月保持
  - CloudWatch エージェントをインストールさえすればオンプレミスのサーバーでも使える
  - Amazon Kinesis Data Firehose はセキュリティチームアカウントで作成でき、CloudWatch Logs サブスクリプションフィルターは各アカウントで作成して Amazon Kinesis Data Firehose と Amazon S3 にログを送信できます。
  - CloudWatch エージェントの awslogs が実行されていない、権限の問題、 awslogs が CloudWatch に接続できない、ログファイルのフィンガープリントの問題、タイムスタンプの問題など、さまざまな問題が考えられます
  - Amzon CloudWatch イベントは、StopLogging の CloudTrail イベントを監視し、Lambda 関数をトリガーしてロギングを再度有効にするように設定できます。また、CloudWatch イベントはリアルタイムであるためダウンタイムは最小限にできます
- AWS GuardDuty
  - CloudTrail, DNS log, VPC flow log からデータを収集する
  - 悪意のある操作や不正な動作を継続的にモニタリングし、AWS アカウントとワークロードを保護
  - 脅威の可能性が検出されると、GuardDuty コンソールと CloudWatch にセキュリティ・アラートを配信
  - IP ホワイトリストを許可している
- AWS Systems Manager
  - EC2 やオンプレミスのサーバーを制御、管理するためのサービス
  - Run Command や Session Manager、Parameter Store などの複数の機能から構成されている
  - リソースを更新、管理、設定する場合は SSM Agent のインストールが必要
  - Inventory では SSM Agent がインストールされたサーバーにインストールされているソフトウェアを一覧表示できる
  - EC2 Runcommand でインスタンス上の authorized_keys を更新することで、SSH キーを変更することができます
  - AWS Systems Manager パラメータストアの SecureString パラメータは追加費用なしで使用できます。また、認証情報を監査することができます
- Amazon Macie
  - S3 上の個人情報などの機密データを自動的に発見、通知、保護処理を行える
- AWS Security Hub
  - セキュリティ状況やコンプライアンスの準拠情報を確認できる
  - AWS Security Hub の CISAWSFoundationsBenchmarkは、AWSのセキュリティ構成のベストプラクティスをまとめたものです。業界で認められているこれらのベストプラクティスは、すでに提供されているハイレベルなセキュリティガイダンスを超えて、AWSユーザーに明確なステップバイステップの実装と評価の手順を提供します。
- Amazon Detective
  - VPC Flow Logs、CloudTrail、GuardDuty などをインプットに、潜在的なセキュリティの問題や不審なアクティビティを分析、調査できるサービス
  - 過去のログやイベント情報といった時系列の観点を含み、グラフ化、可視化するという点で GuardDuty とは目的が異なる

- インシデントの兆候
  - ログとモニタリング
  - 請求の記録
  - 脅威インテリジェンス
  - AWS サポート
  - パブリックレスポンス
- IAM アクセスキーが漏洩した場合
  - 認証情報を無効化する
  - 侵害された認証情報がアタッチされたユーザーに、IAM を拒否するポリシーをアタッチする
    - さらに、残っているセッションを全て取り消す
  - アクセスキーが関連づけられているユーザーを確認する
    - アクセスキーに関連づけられているポリシーの範囲を調べる
  - CloudTrail と AWS Config を使用して何か変更していないかを確認する
    - 他のキーや認証情報が漏洩していないかを最後に確認する

#### ログと監視

- [Amazon Inspector](https://aws.amazon.com/jp/inspector/)
  - Amazon EC2 と ECR のセキュリティ評価を行う
  - チェックルールはマネージドなものしか使用できない
    - 以下を含むサポートされているベースラインに基づいてスキャンを実行
      - CVE
      - CIS ベンチマーク
      - セキュリティのベストプラクティス
      - Network reachability
  - Amazon Inspector は EC2 インスタンスのネットワークアクセシビリティと、インスタンスで実行されるアプリケーションのセキュリティ状態をテストする
    - Amazon Inspector はアプリケーションの露出、脆弱性、ベストプラクティスからの逸脱を評価する
    - ネットワーク到達可能性パッケージルールは、ネットワーク設定を分析して EC2 インスタンスのセキュリティ上の脆弱性を見つけます。
    - Amazon Inspector は EC2 インスタンスの脆弱性をチェックできますが、セキュリティグループへのアクセスは確認できません
- Amazon Kinesis
  - リアルタイムのストリーミングデータを収集、処理、分析する
    - 取り込み
      - Amazon Kinesis Data Streams
        - 保管中および転送中の暗号化を提供している
        - Kinesis Streamsの最大の特徴は「レイテンシの速さ」です。Kinesis Firehoseがデータロードまで60秒を見ているのに対しKinesis Streamsはsub-1、つまり1秒以下でのデータロードにて設計されています。 Kinesis Streamsの使いドコロとしては「次々に上がってくるデータの内容をリアルタイムに加工、表示させたい」というニーズに対応させるのが良いでしょう。LambdaやEC2でStreamsのレコードを拾えるのもすぐに加工してダッシュボード等に表示しやすくするためです。
      - Amazon Kinesis Data Firehose
        - コンテンツを直接ストレージに格納する
        - Kinesis Firehoseの特徴としては「Zero Administration(ゼロ管理)」というのが挙げられます。Kinesis Streamsとは違い、EC2からポーリングしたりLambdaのコードを書く必要は一切ありません。設定を行うだけでS3やRedshiftにデータがそのまま流れます。 S3やRedshiftに大量のデータを溜める目的は何か。それはズバリ「分析用途」です。各種BIツールでデータをわかりやすく表示し、様々なクエリをかけて多様な切り口からデータを分析するためにRedshiftのようなDWHは存在します。 分析するのにデータがputされてから処理するまでのスピードはそれほど求められません。逆に求められるのは大量のデータを効率よく格納する圧縮技術やいかにセキュアにデータを保持するか、という暗号化技術です。 FirehoseはGZIPやSNAPPYといった圧縮アルゴリズムが使えますし、KMSを使った暗号化も可能になっています。
    - 解析
      - Amazon Kinesis Data Analytics
- Amazon Athena
  - S3 内のデータを標準 SQL で分析できるインタラクティブなクエリサービスを提供
- [AWS X-Ray](https://aws.amazon.com/jp/xray/)
  - アプリのサービス間リクエストを収集し、分析するためのサービス
  - 対象のアプリが X-Ray SDK を統合し、エージェントをインストールすることでキャプチャが可能になる
- VPC Flow Logs
  - 送信元/先の IP、通信許可、遮断などのネットワークの基本情報が確認できる
  - CloudWatch と連携させてセキュリティ・アラートを実装するなど
  - パケット情報までは確認できないため、必要に応じてパケットキャプチャツールが必要
- [Amazon QuickSight](https://aws.amazon.com/jp/quicksight/)
  - DB や S3/Athena のデータをダッシュボードビューで可視化できる
  - Salesforce などの SaaS にも接続が可能
- Amazon Kinesis
  - Kinesis Data Streams
    - 大量のストリームデータをリアルタイム処理するためのサービス
  - Kinesis Data Firehose
    - ストリームデータを AWS データストア(S3, RedShift, Elastic)にロードするためのサービス
  - Kinesis Data Analytics
    - ストリームデータをリアルタイムで SQL 処理するためのサービス
  - Kinesis Video Streams
    - 動画データを AWS へストリーミングするためのサービス

#### インフラストラクチャのセキュリティ

- [Amazon Route 53](https://aws.amazon.com/jp/route53/)
  - DNS サービス
  - 他の AWS サービスと連携するように設計できる
  - ヘルスチェックを設定しておくことで、フェイルオーバールーティングを使って異常時に Sorry ページへルーティングすることもできる
  - 位置情報ルーティングを使って大陸別、国別のルーティングを行うことができる
    - セキュリティを目的にサービスを展開していない国からのアクセスを弾いたりもできるのか
  - レイテンシーが最小になるようにルーティングすることができる
  - 加重ルーティングによってリクエスト全体の中から一定の割合のみ別の向き先へルーティングする、といったこともできる
- [AWS WAF](https://aws.amazon.com/jp/waf/)
  - SQLi や XSS のような一般的な攻撃パターンをブロックするカスタムルールや、特定のアプリケーションのために設計されるルールを作成できる
  - リクエストを許可またはブロックする基準
    - クロスサイトスクリプティングの一致
    - IP の一致
    - 地理的な一致
    - サイズの制約
    - SQL インジェクションの一致
    - 文字列の一致
    - 正規表現の一致
  - v1 では10ルールまでだったが、2019/11以降はWAF Capacity Unit という単位に変更され、より複雑な設定が可能になった
  - AWS WAF の ウェブ ACL のレートベースのルールは、正当なトラフィックに影響を与えることなく不要なトラフィックを減らすリクエスト数を制限するために CloudFront ディストリビューションに設定することができます。
- [Amazon CloudFront](https://aws.amazon.com/jp/cloudfront/)
  - 静的データ、動的データを高速に配信するための CDN サービス
  - AWS 内の origin とエッジ間でのデータ転送は無料
  - origin が S3 の場合、CloudFront に Origin Access Identity という特別なユーザー設定をすることで、S3 はそこからの読み取りだけを許容するように設定できる
    - 最近だと Managed Prefix を使うはず
  - ACM証明書をAmazon CloudFrontで使用するには、USEast（N.Virginia）リージョンで証明書をリクエストまたはインポートする必要があります。
- [AWS Shield](https://aws.amazon.com/jp/shield/)
  - Standard ではネットワーク層およびトランスポート層の一般的な DDoS 攻撃に対処
  - Advance ではさらに高度な攻撃や DDoS によるコスト増に対処し、かつ、専門チームのサポートが受けられる
    - アノマリー検知ができる
- ネットワーク ACL(NACL)
  - サブネットレベルで作成、管理される
  - ステートレスなトラフィックフィルター
  - リストを拒否、または許可するためのルール
  - NACL を使用すると、セキュリティグループではできない IP アドレスからのアクセスを拒否することができます。また、NACL はサブネットレベルで機能し、セキュリティグループはインスタンスレベルで機能します。そのため、ポートスキャンはセキュリティグループに到着しません
  - ネットワーク ACL はステートレスです。アウトバウンドルールは、一時ポート 1024～65535に対して有効にする必要があります
  - Network ACL は VPC サブネット間の通信を制御する機能であり、サブネット間通信の場合は SG と NACL の両方で許可されている必要がある
    - Network ACL はステートレスであるため、往路と復路両方の通信をそれぞれのサブネットで許可しておく必要がある
- セキュリティグループ
  - インスタンスの仮装 Fire Wall として機能
  - インスタンスに対するトラフィックへのアクセス制御を行う
  - 一つのインスタンスには複数の Security Group を割り当てられる
  - ステートフルであり、インバウンドトラフィックに対してアウトバウンドルールを定義する必要がない
  - Ingress ルールと egress ルールのみを許可する
  - 通信を許可するには設定が必要
  - Auto Scaling を使用したアプリケーションは IP アドレスを使用して制御ができないため、セキュリティグループにセキュリティグループを関連付けることで制御することができます
    - セキュリティグループでは、接続元をネットワークアドレスで許可することができますが、その替わりに他のセキュリティグループで許可することもできます
  - セキュリティグループとネットワーク ACL のルールは、「送信先 IP」、「プロトコル」、「ポート範囲」のみで、URL ベースのルールを作成することはできません。したがって、VPC にウェブプロキシサーバーを設定し、アウトバウンドアクセスの URL ベースのルールを実施します。そしてデフォルトルートを削除します。
  - セキュリティグループとネットワーク ACL ルール
    - 1行目の ACCEPT は、トラフィックが NACL およびセキュリティグループによって受け入れられたことを示しています。2行目の REJECT は、ステートレスである NACL からの拒否を示します。したがって、VPC の NACL で、アウトバウンドの ICMP トラフィックを許可することで、Ping を動作させることができます。- AMI のセキュリティに関する考慮事項
- [Managing the AWS accounts in your organization](https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_accounts.html)
  - SCP や OU について以下で補足する
- AWS Organizations
  - ルートと呼ばれるマスターアカウントとそれに紐づくメンバーアカウントの２種類のアカウントがある
  - OU という組織単位で管理し、上位階層の OU の設定は下位の OU に引き継がれる
  - サービスコントロールポリシー（SCP）
    - AWS サービスの利用可否を設定し、OU 単位で適用する
    - ルートにも適用できるが、将来的に弊害となる恐れがあるのでルートより下で設定するのが良さそう
    - 別途 IAM ポリシーを設定されている場合、IAM と SCP の両方で許可されているものだけが利用可能となる
  - Organizations 内で組織証跡を設定すると、ログファイルの整合性検証を有効にできる
- AWS Firewall Manager
  - AWS WAF、AWS Shield Advanced、Amazon VPC Security Group を一元管理するためのサービス
  - あらかじめルールを作っておくことによって新たなアプリやリソースに適用できる
  - AWS Organization と統合されているので、複数のアカウントに跨って操作できる
- Elastic LoadBalancing
  - Application LoadBalancer
    - レイヤー7で動作
    - VPC に属する EC2、コンテナ、IP アドレス、Lambda を指定できる
    - 急激なトラフィック増加に対してスケールが間に合わない時がある
  - Network LoadBalancer
    - レイヤー4で動作
    - VPC に属する EC2、コンテナを指定できる
    - 急激なトラフィック増加にも対応
  - Classic LoadBalancer
    - レイヤー4と7の両方で動作
    - EC2-Classic と VPC の両環境で動作する
      - 基本的に EC2-Classic で使われることを想定しており、VPC 環境では ALB か ELB が推奨されている
  - ALB と CLB は動的に IP が割り当てられるので、DNS 名が必要になる
  - ALB と CLB はセキュリティ・グループが使用可能
  - Network Load Balancer と Gateway Load Balancer はリダイレクトをサポートしていない
  - Network Load Balancer に TCP リスナーを設定して、TLS トラフィックをコンテナに通過させることで、復号化を処理し、最も低いレイテンシーで安全なエンドツーエンドの暗号化を実現します- [AWS AutoScaling](https://aws.amazon.com/jp/autoscaling/)
  - EC2、Spot Fleet、ECS タスク、DynamoDB のテーブルとインデックス、Aurora のレプリカが対象
  - CloudWatch メトリクスの増減のほか、スケジュールされたスケールや学習によって予測したスケーリング機能がある
  - 総数を維持する設定では、障害によって動作しないインスタンスが発生したら追加することが可能
- [AWS Artifact](https://aws.amazon.com/jp/artifact/)
  - AWS のセキュリティおよびコンプライアンスレポート(AWS Artifact Report)と特定のオンライン契約にオンデマンドでアクセスできる
  - AWS Artifact Report
    - サードパーティーの監査人による AWS の監査レポートのダウンロードサービス
    - このレポートを利用するには AWS との事業提携契約、秘密保持契約を受諾する必要がある
  - AWS Artifact Agreement
    - AWS と BAA などの契約を締結するためのサービス
- [AWS Control Tower](https://aws.amazon.com/jp/controltower)
  - ブループリントベースでマルチアカウントの AWS 環境のセットアップを自動化
  - ガードレールと呼ばれる必須の、強く推奨されている高レベルルールを提供し、これがサービスコントロールポリシー (SCP) を使用
  - AWS Config とも連携
- AWS Direct Connect
  - AWS への専用ネットワーク接続を作成する

#### ID 及びアクセス管理

- IAM アクセス許可の決定方法
  - ポリシーは AWS のエンティティであり、アイデンティティやリソースにアタッチして、これらのアクセス許可を定義する
  - AWS はユーザーなどのプリンシパルがリクエストを行ったときに、それらのポリシーを評価する
  - 複数の条件を指定したり、単一の条件に複数のキーを指定したりすると、IAM は論理 AND 演算を使用してそれらを評価する
    - 1 つのキーに複数の値を使用して単一の条件を指定すると、IAM は論理 OR 演算を使用して条件を評価する
  - アクセス許可が付与されるには、すべての条件を満たしている必要がある
- ポリシーエレメント
  - JSON ポリシードキュメントはエレメントで構成されており、エレメントには次の 5 つの主要な種類がある
    - Effect: ステートメントの結果を許可または明示的な拒否のどちらにするかを指定する
    - Action: 許可または拒否される動作を指定する
    - Resource: Action の対象となるリソースを指定する
    - Condition: 実行する際に満たす必要のある条件を指定する
    - Principle: ポリシーがアタッチされたリソースにアクセス可能なリソースを指定するリソースベースのポリシーや信頼ポリシーに使用する
- ポリシー管理におけるセキュリティの考慮事項
  - 必要なユーザーにのみアカウントを作成し、それ以外の場合はロールとフェデレーションを利用する
  - インラインポリシーではなくカスタマー管理ポリシーを使用する
  - 各 IAM エンティティには最小限の権限のみを付与する
  - さまざまなエレメントを使用してポリシーサイズを削減する
- AWS Directory Service
  - Microsoft Active Directory を AWS のサービスから使用するために利用できる方法が複数ある
    - AWS Managed Microsoft AD
      - Microsoft AD が AWS クラウド内に必要なケース
      - すでにADインフラストラクチャを持っていて、AD対応のワークロードをAWSクラウドに移行する際にそれを使用したい場合、AWS Managed Microsoft ADが役立ちます。ADトラストを使用して、AWSManagedMicrosoftADを既存のADに接続することができます。これにより、ユーザーはオンプレミスのAD認証情報を使って、ユーザー、グループ、パスワードを同期することなく、AD対応のアプリケーションやAWSアプリケーションにアクセスすることができます。
    - AD Connector
      - オンプレミスのユーザーが AD を介して AWS のサービスにアクセスする必要があるケース
    - Simple AD
      - 小規模で低コストな基本的な AD の機能を提供する

#### データ保護

- Amazon RDS
  - 転送中の保護
    - TLS とネイティブ暗号化クライアントを使用
    - Amazon RDS がアクセス認証を処理
  - 保管中の保護
    - AES-256
    - DB 作成時に有効にする必要がある（後から有効化はできない）
    - 特定の DB エンジンで TDE をサポート
- Amazon DynamoDB
  - 転送中の保護
    - TLS で暗号化されたエンドポイントを使用
    - HMAC-SHA256 署名つきのリクエストのみを許可
  - 保管中の保護
    - CSE または SSE 暗号化オプションをサポート
      - SSE だと AES-256
    - テーブルとインデックスを暗号化
  - DynamoDB はデータの保存時の暗号化をサポートしています。テーブルの作成時に暗号化を有効にする必要があります。既存のテーブルでは暗号化を有効にできません
  - DynamoDB 暗号化クライアントは、クライアント側の暗号化をサポートし、テーブル項目に署名して、保存中および転送中の暗号化を保証します。
- [AWS Secrets Manager](https://aws.amazon.com/jp/secrets-manager/)
  - ライフサイクルを通じてデータベース認証情報、API キー、その他のシークレットを簡単にローテーション、管理、取得する
  - シークレットの安全なローテート
  - アクセスの管理
  - 一元的なセキュリティと監査
  - 従量課金制
- Amazon S3 のデータアクセス保護
  - オブジェクト ACL
    - 個々のオブジェクトへのアクセス権限を付与
    - 別のアカウントが所有するオブジェクトにアクセスする
  - バケット ACL
    - ログ配信グループにバケットへの書き込みアクセスを付与する
  - バケットポリシー
    - バケット ACL よりも幅広いアクセス権限を付与する
    - バケットへのクロスアカウントアクセスを許可する
  - IAM ユーザーポリシー
    - ユーザーとグループを作成し、ポリシーをアタッチすることでアクセス権限を管理する
  - ブロックパブリックアクセス
    - [Blocking public access to your Amazon S3 storage](https://docs.aws.amazon.com/AmazonS3/latest/userguide/access-control-block-public-access.html)
    - 任意のアクセスコントロールリスト (ACL) を介して許可されたバケットとオブジェクトへのパブリックアクセスをブロックする
  - オリジンアクセスアイデンティティ (OAI) を作成し、ディストリビューションに関連付ける必要があります。S3 バケットポリシーは、OAI からのアクセスのみを許可するように変更する必要があります
    - CloudFront は VPC エンドポイントで動作しない。VPC エンドポイントは、EC2 インスタンスから VPC 内の S3 にのみトラフィックをルーティング
  - S3 バケットは IAM ロールを継承できない
  - S3 オブジェクト所有権は、バケット所有者が他の AWS アカウントによってバケットにアップロードされたオブジェクトの所有権を自動的に継承できる S3 の機能
- [Amazon S3 Glacier](https://aws.amazon.com/jp/s3/storage-classes/glacier/)
  - デフォルトで暗号化
  - S3 のライフサイクルルールでも転送できる
  - データ取得後24時間使用が可能
  - データは一括、またはセグメント単位で取得が可能
  - ボールトロック
    - 時間ベースの保持
    - MFA 認証のサポート
    - ロック後はポリシーの変更不可
    - Write Once Read Many のサポート
    - ボールトロックポリシーは、ボールトアクセスポリシーとは異なります。どちらのポリシーも、ボールトへのアクセスを制御します。ただし、ボールトロックポリシーでは、ロックによって変更を禁止することにより、コンプライアンス管理を強力に実施することができます。ボールトロックポリシーは、データへの詳細なアクセス制御が求められることの多い、規制やコンプライアンス管理のデプロイに使用できます。対照的に、ボールトアクセスポリシーでは、コンプライアンスと関係がなく、一時的で、頻繁に変更が発生しやすいアクセス制御を実装します。ボールトロックポリシーとボールトアクセスポリシーは同時に使用できます。たとえば、ボールトロックポリシーで時間ベースのデータ保持ルールを実装し (削除の拒否)、指定したサードパーティやビジネスパートナーに対して読み取り許可を付与することができます (読み取りの許可)
- [Amazon S3 Glacier Vault](https://docs.aws.amazon.com/amazonglacier/latest/dev/vault-lock.html)
- AWS Key Management Service
  - エンベロープ暗号化を使用した２層のキー階層
  - キーを一元的に管理し、セキュリティを保護
  - キーを使用できるユーザーを使用ポリシーで決定
  - 以下のことができる
    - ユニークなエイリアスと説明をつけたマスターキーを作成
    - マスターキーを自動的にローテート
    - キーの無効化、削除
    - CloudTrail を使用してキーの使用を監査
    - キーのインポート
  - キーの保護
    - リソースベースの権限
      - 一時的なアクセス権限、またはより詳細なアクセス権限
    - IAM ポリシーと類似した構文
      - カスタマーマスターキー (CMK) をプログラムで委任する
    - キーの管理、および暗号化/復号を行えるユーザーを指定
      - アクセスを許可するのに使用
- 転送中のデータ保護
  - クライアントとサービスエンドポイント間は TLS
  - パブリックキーインフラストラクチャ内で X.509 を使用
  - 証明書よりサーバーのアイデンティティを検証し、改ざんや偽造を防止
- AWS Certificate Manager
  - パブリックとプライベート両方の証明書を管理
  - 証明書のデプロイや自動更新を容易にする
- クライアント側の暗号化とサーバー側の暗号化
  - CSE 暗号
    - AWS に送信する前にユーザーがデータを暗号化する
    - データは暗号化された状態で保存
    - ユーザーのみが知っているキーとアルゴリズム。
  - SSE 暗号
    - 受信した後に AWS がユーザーに代わってデータを暗号化する
    - エンドユーザーに対して透過的
    - AWS は定期的にマスターキーをローテーションする
  - 鍵の使用履歴は全て CloudTrail に保存される
  - エンベロープ暗号化という仕組みで暗号化を行っており、データを暗号化するための Customer Data Key(CDK) とデータキーを暗号化するための Customer Master Key(CMK)を使うことになる
    - CMK で暗号化できるのは 4KB まで
    - リージョン間で CMK の共有はできない
  - カスタマー管理、AWS 管理、AWS 所有の３種類の CMK がある
    - カスタマー管理 CMK
      - AWS 利用者が作成、所有、管理する。1年ごとの自動ローテーションを有効、無効を設定可能
    - AWS 管理 CMK
      - 3年ごとに AWS 側で自動ローテーションされる
    - AWS 所有 CMK
      - AWS サービスが裏側で使っているもので、利用者が意識することはない
  - CMK は有効化、無効化、再有効化ができる
  - CMK の削除には7〜30日間の待機期間が設けられている
    - この間に使用されたかどうかは CloudWatch や CloudTrail で確認できる
  - CMK をローテーションした後も、CMK はローテーション前のキー情報（バッキングキー）も保持しているため、古いデータも復号できる
  - 1年よりも短いサイクルでキーローテーションをしたい場合、手動ローテーションができる
  - Bring Your Own Key の機能で、ユーザーが作成したキーをインポートすることもできる
    - インポートできるのは 256bit 対象キー
    - 自動ローテートはできない
  - キーポリシーや IAM ポリシーを使ってアクセス制御が可能
  - キーポリシーを使用して、MFA を矯正することが可能
  - KMS の API リクエストにはレート制限があるため、1秒に1万回以上呼び出すとエラーになる
  - 2019/11 から非対称暗号もサポート
  - KMS キーはリージョンに制約されており、リージョンをまたいで複製したりコピーしたりすることはできないため、ターゲットリージョンの AWS サービスがターゲットリージョンのリソースを復号化できるように、ソースリージョンの AWS KMS と通信するように設定します。ただし、KMS キーにはクロスアカウントアクセスを付与することができます
  - (API で利用する際に)アカウントに割り当てられているAWS管理のCMKではなく、顧客管理のCMKを使用するには、keyidパラメータを使用してキーを指定する必要があります。
  - Lambda 関数と EventBridge (CloudWatch Events) は、キーマテリアルをローテーションできない
  - EC2 の EBS ボリュームが KMS で暗号化されている時に追加で必要になるパーミッション
    - "Condition":{"Bool":{"kms:GrantIsForAWSResource":true
    - 「Action」要素にkms:CreateGrant
  - AWS KMS では、キーポリシーおよび許可という 2 つのアクセスコントロールメカニズムをサポートしています。許可を利用すると、AWS KMS keys (KMS キー) の使用を他の AWS プリンシパルにプログラムによって委任できます。これらを使用してアクセスを許可できますが、拒否することはできません。許可は限定的であり、作成と取り消しが容易であるため、一時的なアクセス許可やより詳細なアクセス許可を付与するためによく使用されます。
  - インポートされたキーは、いつでもデータを削除または消去する能力を提供するため、KMS キーでインポートされたキーマテリアルを使用します
- [AWS CloudHSM](https://aws.amazon.com/jp/cloudhsm/)
  - KMS よりも高くてセキュアな高級鍵管理サービス。より厳格なコンプライアンスが求められるユーザー向け
  - 暗号化キーの保存に専用のハードウェアが使用されるため、鍵の内容は AWS も参照することはできない
  - VPC 内に配置する
  - AWS CloudHSM は、ユーザー自身のAmazonVirtualPrivateCloud（VPC）内で動作するため、AmazonEC2インスタンス上で動作するアプリケーションでHSMを容易に使用することができます。

## memo

- [DDoS シミュレーションテストポリシー](https://aws.amazon.com/jp/security/ddos-simulation-testing/)
  - DDoS シミュレーションには AWS Partner Network の協力が必要
- [AssumeRoleWithSAML](https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRoleWithSAML.html)
  - IAM ポリシーは、SAML アサーションによって認証される IAM ロールに割り当てられる

- ActiveDirectoryでは、信頼関係によって様々なリソースへのアクセスが可能になりますが、この信頼関係には一方通行のものと双方向のものがあります。一方向の信頼とは、2つのドメイン間に作成される一方向の認証パスのことです。ドメインAとドメインBの間の一方通行の信頼関係では、ドメインAのユーザーはドメインBのリソースにアクセスできますが、ドメインBのユーザーはドメインAのリソースにはアクセスできません。一方通行の信頼関係には、作成される信頼関係の種類に応じて、非遷移的または遷移的なものがあります。
- AmazonCognitoのIdentityPoolは、ゲスト（未認証）のユーザーや、認証されてトークンを受け取ったユーザーに一時的なAWSクレデンシャルを提供します。

- [AWS KMS のキーポリシー](https://docs.aws.amazon.com/ja_jp/kms/latest/developerguide/key-policies.html#key-policy-default-allow-root-enable-iam)
- EC2 インスタンスのメタデータにアクセスするには、ポート 80 の IPアドレス 169.254.169.254 へのアウトバウンド TCP が通信に必要です
- インポートされたキーマテリアルを使用した KMS キーは手動でローテーションする必要があります。手動ローテーションは、新しい KMS キーを使用してエイリアスを変更することで実行できます

- もしSSL を使いたいが、ロードバランサーに SSL 終端処理をさせたくない場合（SSL オフロードとして知られている）、クライアントからロードバランサーへの接続に TCP を使用し、ロードバランサーからバックエンドアプリケーションへの接続に SSL プロトコルを使用し、リクエストを処理するバックエンドのインスタンスに証明書を配置することができます
- SES SMTP: AWS は email-smtp.us-east1.amazonaws.com にポート 587 で接続することを推奨しています
- Amazon EFS は、ファイルシステムの 2 つの暗号化形式、「転送時の暗号化」と「保管時のデータの暗号化」をサポートします。Amazon EFS ファイルシステムを作成する場合、保管時のデータの暗号化を有効にすることができます。後でファイルシステムをマウントする時、伝送中のデータの暗号化を有効にすることができます
- awsvpc を使用すると、コンテナのセキュリティを強化するタスクネットワーキング機能を提供します。また、IAM ロールは、IAM ベストプラクティスに従ってタスクに割り当てることができます
- アベイラビリティーゾーンは、すべて 100 km 以内 (互いに 60 マイル) に配置されている
- Amazon Cognito が SAML アサーションを受信すると、SAML 属性をユーザープール属性にマッピングできる必要があります。Amazon Cognito が ID プロバイダから SAML アサーションを受信するように設定する場合、ID プロバイダーが Amazon Cognito を証明書利用者として持つように設定されていることを確認する必要があります。Amazon API Gateway は、Amazon Cognito から渡される認証を理解できる必要があります
- 一定期間経過したアクセスキーを検知するようなサービスはないため、自前でスクリプトを組む必要がある
- ルートテーブルは受信トラフィックを制御せず、送信トラフィックのみを制御する
- aws:SourceVpce とプライベート DNS による VPC エンドポイントの作成

- 別の AWS アカウントの所有者と協力して、Amazon Kinesis または Amazon Kinesis Data Firehose ストリームなどのご自身の AWS リソースで相手のログイベントを受信することができます (これをクロスアカウントデータ共有と言います)。たとえば、このログイベントデータを集中管理型の Kinesis または Kinesis Data Firehose ストリームから読み取り、カスタム処理や分析を実行することができます。カスタム処理は、多数のアカウントが協力しデータを分析する場合に特に便利です。
- [IAM ロールの一時的なセキュリティ認証情報の取り消し](https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/id_roles_use_revoke-sessions.html)
- AWS PrivateLink は、アプリケーションを公開することなく、他の AWS アカウントにプライベートエンドポイントを提供します。このアプローチは、アプリケーションへのアクセスを、他の子会社の AWS アカウントが接続できるプライベートエンドポイントのみに制限することができるため、よりスケーラブルで安全です。
